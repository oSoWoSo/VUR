# Template file for 'heroic-games-launcher'
pkgname=heroic-games-launcher
version=2.4.3
revision=1
archs="x86_64 armv7l aarch64 ~*-musl"
wrksrc="HeroicGamesLauncher-${version}"
hostmakedepends="nodejs python3 yarn"
depends="alsa-lib gtk+3 nss python3"
checkdepends="tar xz"
short_desc="Open Source Launcher for GOG and Epic Games"
maintainer="Wiktor Ciurej <wiktor.ciurej@gmail.com>"
license="GPL-3.0-or-later"
homepage="https://github.com/Heroic-Games-Launcher/HeroicGamesLauncher"
distfiles="https://github.com/Heroic-Games-Launcher/HeroicGamesLauncher/archive/v${version}.tar.gz"
checksum=b6590fd99776c2f6d890266ee177d1d90f8a127eaa47b9aec41fc00c4194bc9a
nopie_files="/opt/heroic/resources/app.asar.unpacked/build/bin/linux/gogdl
	/opt/heroic/resources/app.asar.unpacked/build/bin/linux/legendary"

case ${XBPS_TARGET_MACHINE} in
	x86_64*) _arch=x64 ;;
	aarch64*) _arch=arm64 ;;
	armv7l*) _arch=armv7l ;;
	*) broken="There is no electron package provided for selected architecture." ;;
esac

if ! [ ${_arch} == "x64" ]; then
	nostrip_files="/opt/heroic/resources/app.asar.unpacked/build/bin/linux/gogdl
	/opt/heroic/resources/app.asar.unpacked/build/bin/linux/legendary"

	skiprdeps="/opt/heroic/resources/app.asar.unpacked/build/bin/linux/gogdl
	/opt/heroic/resources/app.asar.unpacked/build/bin/linux/legendary"
fi

do_build() {
	npm_config_arch=${_arch} npm_config_platform=linux yarn
	npm_config_arch=${_arch} npm_config_platform=linux yarn dist:linux tar.xz --${_arch}
}

do_check() {
	npm_config_arch=${_arch} yarn test
	npm_config_arch=${_arch} yarn test:ci
}

do_install() {
	vmkdir opt/heroic/
	if [ ${_arch} == "x64" ]; then
		vcopy dist/linux-unpacked/* opt/heroic/
	else
		vcopy dist/linux-${_arch}-unpacked/* opt/heroic/
	fi
	vmkdir usr/bin/
	ln -sf /opt/heroic/heroic ${DESTDIR}/usr/bin/heroic
	vmkdir usr/share/pixmaps/
	vinstall public/icon.png 0755 usr/share/pixmaps/ heroic.png
	vmkdir usr/share/applications/
	vinstall ${FILESDIR}/heroic.desktop 0644 usr/share/applications/
}
