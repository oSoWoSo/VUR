# Template file for 'godot'
pkgname=godot
version=4.0.2
revision=1
archs="x86_64* i686* aarch64* armv7* ppc64*"
build_style=scons
# Build currently fails with embree-4.0.0
make_build_args="platform=linuxbsd target=editor progress=no production=yes
 builtin_embree=true builtin_enet=false builtin_freetype=false
 builtin_graphite=false builtin_harfbuzz=false builtin_libogg=false
 builtin_libpng=false builtin_libtheora=false builtin_libvorbis=false
 builtin_libwebp=false builtin_mbedtls=false builtin_miniupnpc=false
 builtin_pcre2=false builtin_zlib=false builtin_zstd=false"
hostmakedepends="pkg-config clang"
makedepends="alsa-lib-devel freetype-devel mesa glu-devel libXcursor-devel
 libXi-devel libXinerama-devel libXrender-devel libXrandr-devel libX11-devel
 libpng-devel libwebp-devel libogg-devel libtheora-devel libvorbis-devel
 libenet-devel zlib-devel mbedtls-devel miniupnpc-devel pcre2-devel
 pulseaudio-devel graphite-devel harfbuzz-devel libzstd-devel"
short_desc="Multiplatform 2D and 3D engine"
maintainer="Nick Hahn <nick.hahn@hotmail.de>"
license="MIT"
homepage="https://www.godotengine.org/"
distfiles="https://github.com/godotengine/godot/archive/${version}-stable.tar.gz"
checksum=d978282597c5e3a398ad3ade8b5a68d351178c82b197fa6a64045f4abc37e5a6
nocross=https://build.voidlinux.org/builders/armv7l_builder/builds/6342/steps/shell_3/logs/stdio

CFLAGS+=" -fPIE -fPIC"
LDFLAGS+=" -pie"

case "$XBPS_TARGET_MACHINE" in
	*-musl) makedepends+=" libexecinfo-devel speech-dispatcher-devel";;
esac

post_extract() {
	vsed -e 's/#ifdef CRASH_HANDLER_ENABLED/#if defined(CRASH_HANDLER_ENABLED) \&\& defined(__GLIBC__)/' \
		-i platform/linuxbsd/crash_handler_linuxbsd.cpp
}

pre_build() {
	export CXXFLAGS=" $CXXFLAGS "
}

do_install() {
	vlicense LICENSE.txt
	vinstall ${FILESDIR}/godot.desktop 644 /usr/share/applications/
	vinstall ${wrksrc}/icon.png 644 /usr/share/pixmaps/ godot.png


	case "$XBPS_TARGET_MACHINE" in
		x86_64*|aarch64*) vbin bin/godot.linuxbsd.editor.x86_64 godot;;
		ppc64*) vbin bin/godot.linuxbsd.editor.ppc64 godot;;
		*) vbin bin/godot.linuxbsd.editor.x86_32 godot;;
	esac
}
