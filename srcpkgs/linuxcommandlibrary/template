# Template file for 'linuxcommandlibrary'
pkgname=linuxcommandlibrary
version=3.5.10
revision=1
#build_style=gradle
configure_args="--no-daemon --gradle-user-home=/tmp/gradle"
hostmakedepends="openjdk17 gradle"
depends="virtual?java-runtime"
checkdepends="sdkmanager"
short_desc="Linux reference app with basics, tips and formatted man pages"
maintainer="zenobit <zenobit@disroot.org>"
license="Apache-2.0"
homepage="http://linuxcommandlibrary.com/"
distfiles="https://github.com/SimonSchubert/LinuxCommandLibrary/archive/refs/tags/v${version}.tar.gz"
checksum=e9d5701ac1df186467cfc56a44307e2bce286eaaf3ecca6e75e1d43ff4bee634
nopie=yes

export JAVA_HOME=/usr/lib/jvm/openjdk17
export ANDROID_SDK_ROOT=/tmp/android-sdk
if [ "$XBPS_TARGET_MACHINE" = i686 ]; then
	export JAVA_OPTS="-Xmx2048m"
fi

do_build() {
	# Set GRADLE_USER_HOME to avoid using $HOME
	export GRADLE_USER_HOME=/tmp/gradle
	chmod +x gradlew
	# Suppress Android and Kotlin warnings
	echo "" >> gradle.properties
	echo "android.generateSyncIssueWhenLibraryConstraintsAreEnabled=false" >> gradle.properties
	echo "android.dependency.useConstraints=false" >> gradle.properties
	echo "kotlin.mpp.applyDefaultHierarchyTemplate=false" >> gradle.properties
	echo "org.gradle.daemon=false" >> gradle.properties
	# CLI
	./gradlew :cli:linkReleaseExecutableLinuxX64 --no-daemon --stacktrace
	# Desktop
	./gradlew :desktopApp:packageUberJarForCurrentOS --no-daemon --stacktrace
}

do_check() {
	./gradlew :common:cleanTestDebugUnitTest :common:testDebugUnitTest
}

do_install() {
	# CLI
	vbin cli/build/bin/linuxX64/releaseExecutable/lcl.kexe lcl

	# Desktop
	vmkdir usr/share/${pkgname}
	vinstall desktopApp/build/compose/jars/LinuxCommandLibrary-linux-x64-${version}.jar 644 usr/share/${pkgname} ${pkgname}.jar
}

post_install() {
	cat > ${DESTDIR}/usr/bin/linuxcommandlibrary << 'EOF'
#!/bin/sh
exec java -jar /usr/share/linuxcommandlibrary/linuxcommandlibrary.jar "$@"
EOF

	chmod +x "${DESTDIR}/usr/bin/linuxcommandlibrary"
	vmkdir usr/share/applications
	vinstall "${FILESDIR}/lcl.desktop" 0644 "usr/share/applications/"
	vinstall desktopApp/icon.png 644 usr/share/pixmaps linuxcommandlibrary.png
	vinstall desktopApp/icon.png 644 usr/share/icons/hicolor/apps lcl.png
}

linuxcommandlibrary-desktop_package() {
	short_desc+=" - desktop application"
	depends="virtual?java-runtime"
	pkg_install() {
		vmove usr/bin/linuxcommandlibrary
		vmove usr/share/applications
		vmove usr/share/pixmaps
	}
}
