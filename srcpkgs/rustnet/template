# Template file for 'rustnet'
pkgname=rustnet
version=0.17.0
revision=1
build_style=cargo
build_helper="qemu"
hostmakedepends="pkg-config clang19 elfutils-devel"
makedepends="elfutils-devel libpcap-devel"
short_desc="Cross-platform network monitoring terminal UI tool built with Rust"
maintainer="zenobit <zenobit@disroot.org>"
license="Apache-2.0"
homepage="https://github.com/domcyrus/rustnet"
changelog="https://raw.githubusercontent.com/domcyrus/rustnet/refs/heads/main/CHANGELOG.md"
distfiles="https://github.com/domcyrus/rustnet/archive/refs/tags/v${version}.tar.gz"
checksum=e5f7070e74cdbf2629bba1f356205f175c3a836d93b3f15797237b54622f6274

pre_build() {
	case "$XBPS_TARGET_MACHINE" in
		*-musl) configure_args="--no-default-features" ;;
	esac

	if [ "$CROSS_BUILD" ]; then
		# For cross-compilation set right CFLAGS for host and target
		# Rust use format with underscores intead of slashes
		rust_build="${RUST_BUILD//-/_}"
		rust_target="${RUST_TARGET//-/_}"

		# Host CFLAGS (for build skripts and proc macros)
		export CFLAGS_${rust_build}="-O2"
		export CXXFLAGS_${rust_build}="-O2"
		export LDFLAGS_${rust_build}=""

		# Target CFLAGS (for final binary)
		export CFLAGS_${rust_target}="${XBPS_TARGET_CFLAGS}"
		export CXXFLAGS_${rust_target}="${XBPS_TARGET_CXXFLAGS}"
		export LDFLAGS_${rust_target}="${XBPS_TARGET_LDFLAGS}"

		# Clean global variables
		unset CFLAGS CXXFLAGS LDFLAGS
	fi
}

pre_install() {
	# Prevent 98-fixup-gir-path hook from failing
	# This hook is for GObject Introspection and not needed for Rust binaries
	if [ "$CROSS_BUILD" ]; then
		mkdir -p "${PKGDESTDIR}/usr/${XBPS_CROSS_TRIPLET}/usr"
	fi
}
